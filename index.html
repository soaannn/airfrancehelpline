<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Air France Helpline</title>
<style>
  :root {
    --blue: #003399;
    --light-blue: #f0f4f8;
    --gray: #f7f7f7;
    --white: #ffffff;
    --dark-gray: #333333;
    --accent: #ffcc00;
  }
  body {margin:0; font-family: Arial, sans-serif; background-color: var(--light-blue); color: var(--dark-gray);}
  header {background-color: var(--white); padding: 15px 20px; display:flex; align-items:center; border-bottom:2px solid var(--blue);}
  .logo {font-weight: bold; font-size:24px; color: var(--blue); letter-spacing:2px;}
  main {max-width: 900px; margin: 20px auto; padding:10px;}
  h1 {color: var(--blue);}
  .ticket-card {background-color: var(--white); padding:15px; margin-bottom:15px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
  .ticket-title {font-size:18px; font-weight:bold; margin:0 0 5px 0;}
  .ticket-status {font-size:14px; color:#666;}
  button {cursor:pointer; padding:8px 12px; border:none; border-radius:5px; font-weight:bold;}
  .btn-submit {background-color: var(--blue); color: var(--white);}
  .btn-admin {background-color: var(--accent); color: var(--dark-gray); margin-left:5px;}
  #auth-screen {position:fixed; inset:0; display:flex; flex-direction:column; justify-content:center; align-items:center; background-color: var(--light-blue); z-index:9999;}
  #auth-screen input {padding:10px; font-size:16px; margin-bottom:10px; border-radius:5px; border:1px solid #ccc;}
  #auth-screen button {padding:10px 20px; font-size:16px; background-color: var(--blue); color: var(--white); border-radius:5px; border:none;}
  #new-ticket {margin-top:20px;}
  #new-ticket input {width:80%; padding:8px; margin-right:10px; border-radius:5px; border:1px solid #ccc;}
  .ticket-admin-actions button {margin-right:5px;}
</style>
</head>
<body>

<div id="auth-screen">
  <h2>Air France Helpline Login</h2>
  <input type="password" id="code-input" placeholder="Enter access code" />
  <button id="auth-btn">Login</button>
  <p id="auth-error" style="color:red; display:none; margin-top:5px;">Incorrect code, try again.</p>
</div>

<header>
  <div class="logo">Air France Helpline</div>
</header>

<main>
  <h1>Welcome to Air France Helpline</h1>
  <div id="user-view" style="display:none;">
    <div id="new-ticket">
      <input type="text" id="ticket-title" placeholder="Enter ticket title" />
      <button class="btn-submit" id="create-ticket-btn">Create Ticket</button>
      <p id="ticket-error" style="color:red; display:none; margin-top:5px;"></p>
    </div>
    <div id="tickets-container"></div>
  </div>
</main>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const SUPABASE_URL = 'https://yxlzzduvuqcrrwqwmngz.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bHp6ZHV2dXFjcnJ3cXdtbmd6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MDU4MTgsImV4cCI6MjA3MDQ4MTgxOH0.53JEyXxF9paOCRHSOvdzGz9Gr0cubEB7mPuhvlDqwk8'

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
const ACCESS_CODE = '070112'
let currentUser = null
let isAdmin = false

const authScreen = document.getElementById('auth-screen')
const authBtn = document.getElementById('auth-btn')
const codeInput = document.getElementById('code-input')
const authError = document.getElementById('auth-error')
const userView = document.getElementById('user-view')
const ticketsContainer = document.getElementById('tickets-container')
const newTicketDiv = document.getElementById('new-ticket')
const ticketTitleInput = document.getElementById('ticket-title')
const createTicketBtn = document.getElementById('create-ticket-btn')
const ticketError = document.getElementById('ticket-error')

authBtn.addEventListener('click', async ()=>{
  const code = codeInput.value.trim()
  if(code !== ACCESS_CODE){ authError.style.display='block'; return; }
  authError.style.display='none'
  authScreen.style.display='none'

  let { data:userData, error } = await supabase.from('users').select('*').eq('id','client-1').single()
  if(error || !userData){
    await supabase.from('users').insert([{id:'client-1', role:'client'}])
    userData = {id:'client-1', role:'client'}
  }
  currentUser = userData
  isAdmin = userData.role==='admin'
  userView.style.display='block'
  newTicketDiv.style.display = isAdmin ? 'none' : 'block'
  loadTickets()
})

createTicketBtn.addEventListener('click', async ()=>{
  const title = ticketTitleInput.value.trim()
  if(!title){ ticketError.textContent='Title required'; ticketError.style.display='block'; return; }
  const { data:existing } = await supabase.from('tickets').select('*').eq('user_id',currentUser.id)
  if(existing && existing.length>0){ ticketError.textContent='You already have a ticket'; ticketError.style.display='block'; return; }
  await supabase.from('tickets').insert([{user_id:currentUser.id,title,status:'open',message:''}])
  ticketTitleInput.value=''
  ticketError.style.display='none'
  loadTickets()
})

async function loadTickets(){
  let query = supabase.from('tickets').select('*').order('id',{ascending:false})
  if(!isAdmin){ query = query.eq('user_id',currentUser.id) }
  const { data: tickets } = await query
  ticketsContainer.innerHTML=''
  if(!tickets || tickets.length===0){ ticketsContainer.innerHTML='<p>No tickets yet.</p>'; return; }

  tickets.forEach(ticket=>{
    const div = document.createElement('div')
    div.className='ticket-card'
    div.innerHTML=`<div class="ticket-title">${ticket.title}</div><div class="ticket-status">Status: ${ticket.status}</div>`
    if(isAdmin){
      const adminDiv = document.createElement('div')
      adminDiv.className='ticket-admin-actions'
      const btnResolve = document.createElement('button')
      btnResolve.textContent='Mark Resolved'
      btnResolve.className='btn-admin'
      btnResolve.onclick = async ()=>{ await supabase.from('tickets').update({status:'resolved'}).eq('id',ticket.id); loadTickets() }
      const btnDelete = document.createElement('button')
      btnDelete.textContent='Delete'
      btnDelete.className='btn-admin'
      btnDelete.onclick = async ()=>{ await supabase.from('tickets').delete().eq('id',ticket.id); loadTickets() }
      adminDiv.appendChild(btnResolve)
      adminDiv.appendChild(btnDelete)
      div.appendChild(adminDiv)
    }
    ticketsContainer.appendChild(div)
  })
}
</script>
</body>
</html>
